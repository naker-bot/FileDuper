cmake_minimum_required(VERSION 3.16)

project(FileDuper_Proxmox VERSION 1.0.0 LANGUAGES CXX)

# Qt5 Configuration for Proxmox compatibility
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Enable Qt5 MOC, UIC, RCC
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTOUIC ON)
set(CMAKE_AUTORCC ON)

# Find Qt5 components
find_package(Qt5 REQUIRED COMPONENTS 
    Core 
    Widgets 
    Network
    Concurrent
)

# OpenCL optional for Proxmox (may not have GPU)
find_package(OpenCL QUIET)
if(OpenCL_FOUND)
    add_definitions(-DHAVE_OPENCL)
    message(STATUS "OpenCL found - GPU acceleration enabled")
else()
    message(STATUS "OpenCL not found - CPU-only mode")
endif()

# libcurl required
find_package(PkgConfig REQUIRED)
pkg_check_modules(CURL REQUIRED libcurl)

# OpenSSL for FTP authentication
find_package(OpenSSL REQUIRED)

# Source files
set(SOURCES
    src/main.cpp
    src/mainwindow.cpp
    src/scanner.cpp
    src/hashengine.cpp
    src/presetmanager.cpp
    src/networkscanner.cpp
    src/logindialog.cpp
    src/activityindicator.cpp
    src/duplicateresultswidget.cpp
    src/ftpclient.cpp
    src/directoryselectiondialog.cpp
    src/directoryselectordialog.cpp
    src/duplicatedeletedialog.cpp
    src/ftpdirectorydialog.cpp
    src/hierarchicaldialog.cpp
    src/networkdirectorydialog.cpp
    src/simpletreedialog.cpp
    src/npumanager.cpp
)

set(HEADERS
    include/mainwindow.h
    include/scanner.h
    include/hashengine.h
    include/presetmanager.h
    include/networkscanner.h
    include/logindialog.h
    include/activityindicator.h
    include/duplicateresultswidget.h
    include/ftpclient.h
    include/directoryselectiondialog.h
    include/directoryselectordialog.h
    include/duplicatedeletedialog.h
    include/ftpdirectorydialog.h
    include/hierarchicaldialog.h
    include/networkdirectorydialog.h
    include/simpletreedialog.h
    include/npumanager.h
)

# Include directories
include_directories(include)

# Create executable
add_executable(FileDuper_Proxmox ${SOURCES})

# Qt5 setup
qt5_use_modules(FileDuper_Proxmox Core Widgets Network Concurrent)

# Link libraries
target_link_libraries(FileDuper_Proxmox
    Qt5::Core
    Qt5::Widgets
    Qt5::Network
    Qt5::Concurrent
    ${CURL_LIBRARIES}
    OpenSSL::SSL
    OpenSSL::Crypto
    pthread
)

# OpenCL linking if available
if(OpenCL_FOUND)
    target_link_libraries(FileDuper_Proxmox ${OpenCL_LIBRARIES})
    target_include_directories(FileDuper_Proxmox PRIVATE ${OpenCL_INCLUDE_DIRS})
endif()

# Include curl headers
target_include_directories(FileDuper_Proxmox PRIVATE ${CURL_INCLUDE_DIRS})

# Compiler flags for Proxmox compatibility
target_compile_options(FileDuper_Proxmox PRIVATE
    -Wall
    -Wextra
    -O2
    -DPROXMOX_BUILD
    -DQT_NO_DEBUG_OUTPUT  # Reduce debug output for production
)

# Installation rules
install(TARGETS FileDuper_Proxmox 
    RUNTIME DESTINATION bin
)

# Create desktop file
configure_file(
    ${CMAKE_SOURCE_DIR}/install/fileduper.desktop.in
    ${CMAKE_BINARY_DIR}/fileduper.desktop
    @ONLY
)

install(FILES ${CMAKE_BINARY_DIR}/fileduper.desktop
    DESTINATION share/applications
)

# Icon installation
install(FILES assets/icons/fileduper.png
    DESTINATION share/icons/hicolor/64x64/apps
)
