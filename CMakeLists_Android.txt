cmake_minimum_required(VERSION 3.21)
project(EnigmaChat VERSION 1.0.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Android-specific settings
set(ANDROID TRUE)
set(CMAKE_ANDROID_ARCH_ABI arm64-v8a)  # Modern 64-bit ARM
set(CMAKE_ANDROID_STL_TYPE c++_shared)

# Enable Qt MOC/UIC/RCC automation
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTOUIC ON)
set(CMAKE_AUTORCC ON)

# Find Qt6 Android components
find_package(Qt6 REQUIRED COMPONENTS Core Widgets Network Sql)

# Source files
set(SOURCES
    src/main.cpp
    src/enigmachat.cpp
    src/asyncenigmaclient.cpp
    src/asyncchatwindow.cpp
    src/cryptoengine.cpp
    src/internetdiscovery.cpp
)

set(HEADERS
    include/enigmachat.h
    include/asyncenigmaclient.h
    include/asyncchatwindow.h
    include/cryptoengine.h
    include/internetdiscovery.h
)

# Android-specific adjustments
if(ANDROID)
    # Remove desktop-specific features
    add_definitions(-DANDROID_BUILD)
    
    # Add Android permissions
    set(ANDROID_PACKAGE_SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/android)
    
    # Create executable
    qt6_add_executable(EnigmaChat ${SOURCES} ${HEADERS})
    
    # Link Qt6 libraries for Android
    target_link_libraries(EnigmaChat
        Qt6::Core
        Qt6::Widgets
        Qt6::Network
        Qt6::Sql
    )
    
    # Android-specific properties
    set_target_properties(EnigmaChat PROPERTIES
        QT_ANDROID_PACKAGE_SOURCE_DIR ${ANDROID_PACKAGE_SOURCE_DIR}
        QT_ANDROID_TARGET_SDK_VERSION 33
        QT_ANDROID_MIN_SDK_VERSION 26
    )
    
else()
    # Desktop build (existing)
    qt6_add_executable(EnigmaChat ${SOURCES} ${HEADERS})
    
    target_link_libraries(EnigmaChat
        Qt6::Core
        Qt6::Widgets
        Qt6::Network
        Qt6::Sql
        OpenSSL::SSL
        OpenSSL::Crypto
        Threads::Threads
    )
endif()

# Include directories
target_include_directories(EnigmaChat PRIVATE include)

# Compiler flags
target_compile_options(EnigmaChat PRIVATE -Wall -Wextra -O3)
